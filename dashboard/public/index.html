<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <base href="https://113.161.220.166:3001/" /> -->
    <base href="https://192.168.1.50:3001/" />
    <title>Smart Meter Dashboard - Electricity Monitoring</title>
    <meta name="description" content="Real-time electricity meter monitoring dashboard with modern UI">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="assets/css/style.css" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">

    <style>
        /* Additional modern overrides */
        .brand-icon {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--electric-gradient);
            border-radius: 12px;
        }

        .brand-title {
            font-size: 1.1rem;
            line-height: 1.2;
        }

        .brand-subtitle {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .user-avatar {
            font-size: 1.2rem;
        }

        .dropdown-menu {
            border: none;
            box-shadow: var(--shadow-xl);
            border-radius: var(--radius-lg);
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
        }

        .dropdown-item:hover {
            background: rgba(0, 212, 255, 0.1);
            color: var(--electric-blue);
        }

        .dropdown-item i {
            width: 16px;
        }

        /* Status dot animation */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            display: inline-block;
            margin-right: 6px;
            animation: pulse-electric 2s infinite;
        }

        /* Loading animations */
        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }

            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--electric-blue);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--electric-blue-dark);
        }
    </style>
</head>

<body>
    <div id="nav"></div>

    <main id="content" class="container my-4">
        <!-- Dynamic content will be injected here -->
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script>window.WS_PORT = 3001;</script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/sockets.js"></script>
    <script src="assets/js/ui.settings.js"></script>
    <script src="assets/js/ui.js"></script>
    <script>
        // Immediate check when UI script loads
        (function () {
            const checkUIReady = () => {
                if (window.UI && typeof window.UI.quickAuthCheck === 'function') {
                    const token = localStorage.getItem('token');
                    const username = localStorage.getItem('username');
                    if (token && username) {
                        console.log('ðŸš€ Immediate auth check when UI loads...');
                        window.UI.quickAuthCheck();
                    }
                } else {
                    setTimeout(checkUIReady, 10);
                }
            };
            checkUIReady();
        })();
    </script>
    <script src="assets/js/ui.dashboard.js" defer></script>
    <script src="assets/js/ui.devices.js" defer></script>
    <script src="assets/js/ui.realtime.js" defer></script>
    <script src="assets/js/ui.auth.js" defer></script>
    <script>
        // Function to check if all required modules are loaded
        const waitForModules = () => {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100; // Max 5 seconds

                const checkModules = () => {
                    attempts++;
                    console.log(`Checking modules (attempt ${attempts})...`);
                    console.log('UI available:', !!window.UI);
                    console.log('AuthUI available:', !!window.AuthUI);
                    console.log('DashboardUI available:', !!window.DashboardUI);
                    console.log('DevicesUI available:', !!window.DevicesUI);

                    if (window.UI && typeof window.UI.init === 'function') {
                        console.log('âœ… UI module loaded!');

                        // UI loaded, now check other modules (optional)
                        if (window.AuthUI && window.DashboardUI && window.DevicesUI) {
                            console.log('âœ… All modules loaded!');
                            resolve();
                        } else {
                            console.log('âš ï¸ UI loaded but some components missing, proceeding anyway...');
                            resolve(); // Proceed with UI even if components missing
                        }
                    } else if (attempts >= maxAttempts) {
                        console.error('âŒ Timeout waiting for UI module');
                        resolve(); // Proceed anyway to avoid infinite wait
                    } else {
                        console.log('â³ Waiting for UI module...');
                        setTimeout(checkModules, 50);
                    }
                };
                checkModules();
            });
        };

        // Function to check if nav elements are ready
        const waitForNavElements = () => {
            return new Promise((resolve) => {
                const checkNav = () => {
                    const nav = document.getElementById('nav');
                    const userDisplayName = document.getElementById('userDisplayName');
                    const loginLink = document.getElementById('loginLink');

                    console.log('Checking nav elements:');
                    console.log('  nav:', !!nav);
                    console.log('  userDisplayName:', !!userDisplayName);
                    console.log('  loginLink:', !!loginLink);

                    if (nav && userDisplayName && loginLink) {
                        console.log('âœ… Nav elements are ready');
                        resolve();
                    } else {
                        console.log('â³ Waiting for nav elements...');
                        setTimeout(checkNav, 50);
                    }
                };
                checkNav();
            });
        };

        (async () => {
            try {
                // Load navigation first
                console.log('Loading navigation...');
                const navHtml = await fetch('assets/components/nav.html').then(r => r.text());
                document.getElementById('nav').innerHTML = navHtml;
                console.log('Navigation HTML loaded');

                // Wait for nav elements to be ready
                await waitForNavElements();

                // Quick auth check immediately after nav is ready
                const token = localStorage.getItem('token');
                const username = localStorage.getItem('username');
                console.log('=== PAGE LOAD AUTH CHECK ===');
                console.log('Token in localStorage:', !!token);
                console.log('Username in localStorage:', username);

                if (token && username) {
                    console.log('Credentials found, will update UI after modules load');

                    // Set up a function to run after UI module loads
                    const runAuthCheck = () => {
                        if (window.UI && typeof window.UI.quickAuthCheck === 'function') {
                            console.log('Running quick auth check...');
                            window.UI.quickAuthCheck();
                            return true;
                        }
                        return false;
                    };

                    // Try immediately
                    if (!runAuthCheck()) {
                        // If not ready, try again after modules load
                        console.log('UI not ready, will check after modules load...');
                    }
                } else {
                    console.log('No credentials found in localStorage');
                }

                // Wait for UI module to load (main requirement)
                await waitForModules();

                // Quick auth check immediately when UI is available

                if (token && username) {
                    console.log('Credentials found, running quick auth check...');
                    if (window.UI && typeof window.UI.quickAuthCheck === 'function') {
                        window.UI.quickAuthCheck();
                    } else {
                        console.error('UI.quickAuthCheck not available after modules loaded');
                    }
                } else {
                    console.log('No credentials found');
                }

                // Initialize UI (full check)
                if (window.UI && typeof window.UI.init === 'function') {
                    console.log('Initializing UI...');
                    window.UI.init();
                } else {
                    console.error('âŒ UI module still not loaded properly');
                }

                // Initialize UI (full check)
                if (window.UI && typeof window.UI.init === 'function') {
                    console.log('Initializing UI...');
                    window.UI.init();
                } else {
                    console.error('UI module not loaded properly');
                }

                // Add global debug functions
                window.checkLoginStatus = () => {
                    if (window.UI && typeof UI.checkLoginStatus === 'function') {
                        UI.checkLoginStatus();
                    } else {
                        console.error('UI.checkLoginStatus not available');
                    }
                };

                window.forceRefreshUI = () => {
                    if (window.UI && typeof UI.forceRefreshUI === 'function') {
                        UI.forceRefreshUI();
                    } else {
                        console.error('UI.forceRefreshUI not available');
                    }
                };

                window.quickAuthCheck = () => {
                    if (window.UI && typeof UI.quickAuthCheck === 'function') {
                        UI.quickAuthCheck();
                    } else {
                        console.error('UI.quickAuthCheck not available');
                    }
                };

                window.testLogout = () => {
                    console.log('ðŸ§ª Testing logout...');
                    const logoutBtn = document.getElementById('logoutBtn');
                    if (logoutBtn && logoutBtn.style.display !== 'none') {
                        console.log('Found visible logout button, clicking...');
                        logoutBtn.click();
                    } else {
                        console.log('Logout button not found or hidden, trying manual logout...');
                        if (window.UI && typeof UI.manualLogout === 'function') {
                            UI.manualLogout();
                        } else {
                            // Fallback manual logout
                            localStorage.removeItem('token');
                            localStorage.removeItem('username');
                            console.log('Fallback manual logout completed');
                        }
                    }
                };

                window.showLogoutBtn = () => {
                    const logoutBtn = document.getElementById('logoutBtn');
                    const loginLink = document.getElementById('loginLink');
                    if (logoutBtn) {
                        logoutBtn.style.display = '';
                        console.log('Logout button shown');
                    }
                    if (loginLink) {
                        loginLink.style.display = 'none';
                        console.log('Login link hidden');
                    }
                };

                console.log('ðŸ”§ Debug functions:');
                console.log('  - checkLoginStatus() : Verify login status');
                console.log('  - forceRefreshUI() : Force refresh UI state');
                console.log('  - quickAuthCheck() : Quick auth check');
                console.log('  - testLogout() : Test logout functionality');
                console.log('  - showLogoutBtn() : Force show logout button');
                console.log('  - UI.manualLogout() : Direct UI logout');

                // Add global debug functions
                window.checkLoginStatus = () => {
                    if (window.UI && typeof UI.checkLoginStatus === 'function') {
                        UI.checkLoginStatus();
                    } else {
                        console.error('UI.checkLoginStatus not available');
                    }
                };

                window.forceRefreshUI = () => {
                    if (window.UI && typeof UI.forceRefreshUI === 'function') {
                        UI.forceRefreshUI();
                    } else {
                        console.error('UI.forceRefreshUI not available');
                    }
                };

                window.quickAuthCheck = () => {
                    if (window.UI && typeof UI.quickAuthCheck === 'function') {
                        UI.quickAuthCheck();
                    } else {
                        console.error('UI.quickAuthCheck not available');
                    }
                };

                window.quickAuthCheck = () => {
                    if (window.UI && typeof UI.quickAuthCheck === 'function') {
                        UI.quickAuthCheck();
                    } else {
                        console.error('UI.quickAuthCheck not available');
                    }
                };

                // Watch for nav changes and auto-update UI
                const navObserver = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList' && mutation.target.id === 'nav') {
                            console.log('Nav content changed, checking authentication...');
                            // Small delay to ensure DOM is updated
                            setTimeout(() => {
                                if (window.UI && typeof UI.init === 'function') {
                                    const token = localStorage.getItem('token');
                                    if (token) {
                                        console.log('Token found, re-initializing UI...');
                                        UI.init();
                                    }
                                }
                            }, 50);
                        }
                    });
                });

                // Start observing nav changes
                const navElement = document.getElementById('nav');
                if (navElement) {
                    navObserver.observe(navElement, { childList: true, subtree: true });
                    console.log('Nav observer started');
                } else {
                    console.log('Nav element not found for observer');
                }

                // Additional check: monitor UI initialization
                const checkUIInit = () => {
                    if (window.uiInitialized) {
                        console.log('UI initialized, running final auth check...');
                        const token = localStorage.getItem('token');
                        const username = localStorage.getItem('username');
                        if (token && username && window.UI && typeof window.UI.quickAuthCheck === 'function') {
                            window.UI.quickAuthCheck();
                        }
                    } else {
                        setTimeout(checkUIInit, 100);
                    }
                };
                setTimeout(checkUIInit, 200);

                console.log('ðŸ”§ Debug functions:');
                console.log('  - checkLoginStatus() : Verify login status with API call');
                console.log('  - forceRefreshUI() : Force refresh UI state');
                console.log('  - quickAuthCheck() : Quick auth check without API call');
                console.log('  - UI.quickAuthCheck() : Direct call to UI method');
            } catch (error) {
                console.error('Error loading navigation:', error);
            }
        })();
    </script>
    <!-- <script src="assets/js/app.js"></script> -->
</body>

</html>